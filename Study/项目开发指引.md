# PDF.js 项目开发指引

## 项目概述

PDF.js 是 Mozilla 开发的一个基于 HTML5 的 PDF 查看器，采用开源社区驱动模式。项目支持现代浏览器，提供完整的 PDF 解析和渲染功能。

## 环境要求

- **Node.js**: >= 20.16.0 或 >= 22.3.0
- **包管理器**: npm (随 Node.js 安装)
- **操作系统**: Windows, macOS, Linux

## 项目初始化

### 1. 克隆项目

```bash
git clone https://github.com/mozilla/pdf.js.git
cd pdf.js
```

### 2. 安装依赖

```bash
npm install
```

### 3. 验证安装

```bash
npx gulp --version
# 应该显示 gulp 版本信息
```

## 开发模式设置

### 启动开发服务器

```bash
npx gulp server
```

启动后访问：

- **主查看器**: http://localhost:8888/web/viewer.html
- **测试文件**: http://localhost:8888/test/pdfs/?frame
- **集成示例**: http://localhost:8888/Study/INTEGRATION_EXAMPLES/

### 开发模式特点

- 实时编译和热重载
- 源码调试支持
- 模块化开发环境
- 自动构建和监听文件变化

### 源码修改自动重新编译机制

#### 1. 文件监听配置

PDF.js 使用 Gulp + Webpack 配置了文件监听功能，自动监控以下目录的文件变化：

**监听范围**：

- `src/` 目录下的所有 JavaScript 文件
- `web/` 目录下的所有 JavaScript、CSS、HTML 文件
- 配置文件（如 `gulpfile.mjs`、`package.json` 等）

#### 2. 开发模式下的文件引用方式

**开发模式**（使用 `npx gulp server` 启动）：

```html
<!-- viewer.html 中的配置 -->
<script type="importmap">
  {
    "imports": {
      "pdfjs/": "../src/",
      "pdfjs-lib": "../src/pdf.js",
      "pdfjs-web/": "./"
    }
  }
</script>
<script src="viewer.js" type="module"></script>
```

**特点**：

- ✅ **直接引用源码**：通过 importmap 直接加载 `/src/` 和 `/web/` 目录下的源文件
- ✅ **无需编译等待**：修改源码后保存即可生效
- ✅ **即时生效**：刷新浏览器即可看到修改效果

#### 3. 自动重新编译流程

当检测到文件变化时，系统会触发以下流程：

```
文件修改 → Webpack 检测变化 → 重新编译 → 生成新构建文件 → 控制台显示编译状态
```

**控制台输出示例**：

```
[HH:MM:SS] asset viewer.mjs XXX KiB [emitted] [javascript module] (name: main)
webpack 5.103.0 compiled successfully
[HH:MM:SS] Finished 'rebuildCore' after X.XX s
```

#### 4. 不同类型文件的处理方式

**需要自动编译的文件**：

- `/web/viewer.js` → 编译为 `/build/dev/web/viewer.mjs`
- `/src/` 目录下的核心库文件
- 任何需要 Webpack 打包的 JavaScript 模块

**无需自动编译的文件**：

- `/Study/INTEGRATION_EXAMPLES/` 目录下的 HTML 集成示例文件
- 静态资源文件（如图片、字体等）
- 配置文件

#### 5. 修改确认流程

**步骤1：修改源码文件**

```bash
# 修改 /src/ 或 /web/ 目录中的源文件
vim /Users/Tiandiyiqi/Documents/Prepress/pdf.js/web/viewer.js
```

**步骤2：观察控制台输出**

- 查看终端是否显示重新编译信息
- 确认编译成功无错误

**步骤3：手动刷新浏览器**

- 在浏览器中按 `F5` 或 `Cmd+R` (Mac) 刷新页面
- 访问：http://localhost:8888/web/viewer.html

**步骤4：验证修改效果**

- 使用浏览器开发者工具检查修改
- 测试相关功能是否正常

#### 6. 修改未生效的排查步骤

**1. 检查文件监听状态**

```bash
# 确认 Gulp 任务仍在运行
ps aux | grep gulp
```

**2. 验证编译输出**

- 查看控制台是否有编译错误
- 检查构建产物修改时间

**3. 清除浏览器缓存**

- 按 `Cmd+Shift+R` (Mac) 强制刷新
- 在开发者工具中勾选 **Disable cache**

**4. 重启开发服务器**

```bash
# 停止当前服务器
Ctrl+C

# 重新启动
npx gulp server
```

#### 7. 最佳实践建议

1. **保存后等待 2-3 秒**，给 Webpack 编译留出时间
2. **观察控制台输出**，确认编译成功后再刷新浏览器
3. **使用开发者工具**的 Network 面板确认文件重新加载
4. **定期重启开发服务器**，避免内存泄漏或文件监听失效
5. **备份重要修改**，避免构建过程中意外丢失

## 项目结构详解

### 核心目录结构

```
pdf.js/
├── src/                    # 核心源码目录
│   ├── core/              # 核心解析模块
│   ├── display/           # 显示渲染模块
│   ├── pdf.js            # 主入口文件
│   └── shared/           # 共享工具模块
├── web/                   # Web 界面相关文件
│   ├── viewer.html       # 主查看器页面
│   ├── viewer.js         # 查看器逻辑
│   ├── viewer.css        # 查看器样式
│   ├── pdfjs.js          # PDF.js 核心库
│   ├── ui_utils.js       # UI 工具函数
│   ├── toolbar.js        # 工具栏组件
│   ├── sidebar.js        # 侧边栏组件
│   └── images/           # 界面图标资源
├── build/                # 构建输出目录
│   └── dev/              # 开发模式构建文件
│       └── web/
│           └── viewer.mjs # 编译后的查看器模块
├── Study/                # 学习研究目录
│   └── INTEGRATION_EXAMPLES/ # 集成示例
├── test/                 # 测试相关文件
└── external/             # 外部依赖库
```

### 主要功能模块位置

#### 1. 核心解析模块 (`src/`)

- **PDF 解析**: `src/core/` - PDF 文件结构解析
- **字体处理**: `src/core/fonts.js` - 字体解析和渲染
- **图像解码**: `src/core/image.js` - 图像处理
- **XFA 表单**: `src/core/xfa/` - 动态表单支持

#### 2. 显示渲染模块 (`src/display/`)

- **页面渲染**: 页面内容绘制和显示
- **Canvas 操作**: Canvas 渲染引擎
- **文本层**: 文本选择和搜索功能

#### 3. Web 界面模块 (`web/`)

- **查看器界面**: `web/viewer.html` - 完整 UI 结构
- **样式文件**: `web/viewer.css` - 界面样式定义
- **工具栏**: `web/toolbar.js` - 工具栏功能实现
- **侧边栏**: `web/sidebar.js` - 缩略图和大纲功能
- **UI 工具**: `web/ui_utils.js` - 通用 UI 功能

#### 4. 构建系统 (`gulpfile.mjs`)

- **任务定义**: Gulp 构建任务配置
- **开发模式**: 源码编译和服务器启动
- **生产构建**: 优化和压缩输出

## 开发工作流程

### 1. 开发模式工作流

```
源码修改 → 实时编译 → 浏览器自动刷新
```

**文件引用关系**:

- `viewer.html` → `viewer.js` (开发模式)
- `viewer.js` → `pdfjs.js` + `ui_utils.js` + 其他模块
- Webpack 实时编译生成 `viewer.mjs`

### 2. 生产模式工作流

```
源码编译 → 优化打包 → 生成生产文件
```

**构建命令**:

```bash
# 生成通用构建版本
npx gulp generic

# 支持旧版浏览器的构建
npx gulp generic-legacy

# 生成组件版本
npx gulp components
```

## 调试技巧

### 1. 浏览器调试

- **开发者工具**: 使用 Chrome/Firefox 开发者工具
- **源码映射**: 开发模式下支持源码调试
- **断点设置**: 在 `web/` 目录下的 JS 文件中设置断点

### 2. 控制台调试

```javascript
// 获取当前 PDF 文档实例
PDFViewerApplication.pdfDocument;

// 获取当前页面信息
PDFViewerApplication.page;

// 查看渲染状态
PDFViewerApplication.pdfViewer.renderingStates;
```

### 3. 日志调试

```javascript
// 启用详细日志
localStorage.setItem("pdfjsDebug", "true");

// 查看特定模块日志
console.log("PDF.js version:", PDFJS.version);
```

## 自定义开发

### 1. 界面定制

- **修改样式**: 编辑 `web/viewer.css`
- **调整布局**: 修改 `web/viewer.html` 结构
- **添加功能**: 扩展 `web/viewer.js`

### 2. 功能扩展

- **工具栏按钮**: 在 `web/toolbar.js` 中添加
- **侧边栏面板**: 扩展 `web/sidebar.js`
- **事件处理**: 监听 PDF.js 事件系统

### 3. 集成方式

- **完整查看器**: 使用 iframe 集成 `viewer.html`
- **核心库集成**: 直接使用 `pdfjs.js` 核心功能
- **组件集成**: 使用构建后的组件版本

## 常见构建任务

### 开发相关任务

```bash
# 启动开发服务器
npx gulp server

# 仅构建开发版本
npx gulp dev

# 监听文件变化自动构建
npx gulp watch
```

### 测试相关任务

```bash
# 运行单元测试
npx gulp test

# 运行集成测试
npx gulp test-integration

# 生成测试覆盖率报告
npx gulp coverage
```

### 生产构建任务

```bash
# 构建通用版本
npx gulp generic

# 构建最小化版本
npx gulp minified

# 构建库版本
npx gulp lib
```

## 故障排除

### 常见问题

1. **依赖安装失败**
   - 检查 Node.js 版本要求
   - 清理 npm 缓存: `npm cache clean --force`
   - 重新安装: `rm -rf node_modules && npm install`

2. **开发服务器无法启动**
   - 检查端口 8888 是否被占用
   - 查看 gulp 错误日志
   - 重启开发服务器

3. **源码修改不生效**
   - 确认开发服务器正在运行
   - 检查浏览器缓存
   - 查看控制台错误信息

### 性能优化建议

1. **开发阶段**
   - 使用开发模式进行调试
   - 合理使用断点和日志
   - 避免频繁的全量构建

2. **生产阶段**
   - 使用优化后的构建版本
   - 启用代码压缩和混淆
   - 配置合适的缓存策略

## 扩展资源

### 官方文档

- [GitHub 仓库](https://github.com/mozilla/pdf.js)
- [API 文档](https://mozilla.github.io/pdf.js/api/)
- [示例代码](https://github.com/mozilla/pdf.js/tree/master/examples)

### 学习资源

- [交互式示例](https://mozilla.github.io/pdf.js/examples/index.html#interactive-examples)
- [常见问题解答](https://github.com/mozilla/pdf.js/wiki/Frequently-Asked-Questions)
- [贡献指南](https://github.com/mozilla/pdf.js/wiki/Contributing)

---

_最后更新: 2024年_  
_基于 PDF.js 最新开发版本编写_
